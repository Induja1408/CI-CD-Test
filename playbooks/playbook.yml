---
- name: Deploy Java app in Docker container
  hosts: java_app_servers
  become: true

  vars:
    docker_package: docker.io         # for Ubuntu/Debian
    docker_service: docker
    dockerhub_image: "iamindu/ci-cd-test"
    container_name: "ci-cd-test-app"
    container_port: 8080              # port inside container
    host_port: 8080                   # port exposed on host

  tasks:
    - name: Ensure apt cache is up to date
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Ensure Docker is installed
      apt:
        name: "{{ docker_package }}"
        state: present

    - name: Ensure Docker service is enabled and running
      service:
        name: "{{ docker_service }}"
        state: started
        enabled: yes

    - name: Pull application image from Docker Hub
      community.docker.docker_image:
        name: "{{ dockerhub_image }}"
        tag: latest
        source: pull

    - name: Run application container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ dockerhub_image }}:latest"
        state: started
        restart_policy: always
        ports:
          - "{{ host_port }}:{{ container_port }}"
        # add env vars, volumes etc. here if needed

    - name: Show running container
      shell: docker ps --filter "name={{ container_name }}" || true
      register: docker_ps
      changed_when: false

    - debug:
        var: docker_ps.stdout_lines
